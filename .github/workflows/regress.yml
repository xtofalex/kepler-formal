# GitHub Actions workflow to build kepler-formal and run it on the example inputs
name: regress

on:
  push:
  pull_request:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build repository
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Verify kepler-formal binary exists
        run: |
          if [ ! -x build/src/bin/kepler-formal ]; then
            echo "ERROR: build/src/bin/kepler-formal not found or not executable"
            ls -R build || true
            exit 1
          fi
          echo "Found build/src/bin/kepler-formal"

      - name: Run regress test with example files
        run: |
          mkdir -p regress-output
          # Run kepler-formal on the example files (files are in example/)
          build/src/bin/kepler-formal \
            example/tinyrocket_naja.if \
            example/tinyrocket_naja.if \
            example/NangateOpenCellLibrary_typical.lib \
            example/fakeram45_1024x32.lib \
            example/fakeram45_64x32.lib \
            > regress-output/run.log 2>&1 || (cat regress-output/run.log && exit 1)
          echo "Run completed; logs at regress-output/run.log"

      - name: Upload regress logs
        uses: actions/upload-artifact@v4
        with:
          name: regress-logs
          path: regress-output
